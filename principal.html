<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CONAVERSE - CONALEP 165 Tuxpan</title>

  <!-- Firebase compat libs (incluye storage) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

  <style>
    /* ====== RESET / BASE ====== */
    *{box-sizing:border-box}
    body{
      margin:0;font-family:'Roboto',sans-serif;background:#f0f2f5;color:#222;
    }

    /* ====== NAV BAR (pesta√±as) ====== */
    .topbar{
      background:#ffffff;border-bottom:1px solid #e6e6e6;display:flex;align-items:center;justify-content:space-between;padding:8px 18px;position:sticky;top:0;z-index:60;
      box-shadow:0 1px 3px rgba(0,0,0,0.04);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:48px;border-radius:6px}
    .tabs{display:flex;gap:8px;align-items:center}
    .tab{
      padding:10px 14px;border-radius:8px;background:transparent;border:none;cursor:pointer;font-weight:600;color:#333;
      transition: all 0.2s ease;
    }
    .tab:hover {
      background: rgba(0, 99, 65, 0.1);
    }
    .tab.active{background:#006341;color:white;box-shadow:0 4px 8px rgba(0,0,0,0.08)}

    /* ====== LAYOUT ====== */
    .container{max-width:1200px;margin:20px auto;display:grid;grid-template-columns:320px 1fr 320px;gap:20px;padding:0 12px}
    @media(max-width:1000px){.container{grid-template-columns:1fr;}.right-column,.left-column{order:2}}

    /* ====== LEFT / RIGHT COLUMN cards (info/galer√≠a) ====== */
    .card{background:white;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .left-column .card img{max-width:100%;display:block;border-radius:8px}

    /* ====== FEED / POST COMPOSER ====== */
    .composer{background:white;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:16px;}
    .composer-top{display:flex;gap:12px;align-items:flex-start}
    .avatar{width:48px;height:48px;border-radius:50%;background:#ddd;display:inline-block}
    .composer-input{flex:1}
    #post-text{width:100%;min-height:70px;border-radius:10px;border:1px solid #e6e6e6;padding:10px;font-size:15px;resize:vertical;transition: border-color 0.2s ease;}
    #post-text:focus {
      outline: none;
      border-color: #006341;
    }
    .composer-actions{display:flex;align-items:center;justify-content:space-between;margin-top:12px}
    .attach-btn{display:flex;gap:8px;align-items:center}
    .btn{
      background:#006341;color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600;
      transition: background-color 0.2s ease;
    }
    .btn:hover {
      background: #004d33;
    }
    .btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    .btn.secondary{background:transparent;color:#006341;border:1px solid #006341}
    .btn.secondary:hover {
      background: rgba(0, 99, 65, 0.1);
    }
    input[type=file]{display:none}

    .preview-area{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    .file-preview{border-radius:8px;padding:6px;background:#fafafa;border:1px solid #ececec;display:flex;align-items:center;gap:8px}
    .file-preview img{max-width:140px;max-height:120px;border-radius:6px}
    .file-preview video{max-width:200px;max-height:140px;border-radius:6px}
    .progress{height:8px;background:#e6e6e6;border-radius:8px;width:100%;overflow:hidden;margin-top:8px}
    .progress > i{display:block;height:100%;background:#006341;width:0%;transition: width 0.3s ease;}

    /* ====== POST CARD ====== */
    .post{background:white;border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,0.05);transition: transform 0.2s ease;}
    .post:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }
    .post .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .post .meta .left{display:flex;gap:10px;align-items:center}
    .post .meta .left .name{font-weight:700}
    .post .body{font-size:15px;margin-bottom:10px;white-space:pre-wrap}
    .post .media{margin-top:8px}
    .post .actions{display:flex;gap:12px;margin-top:10px;color:#555;font-weight:600}
    .post-action {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .post-action:hover {
      color: #006341;
    }

    /* small tweaks */
    h1.page-title{text-align:center;color:#006341;font-family:'Poppins',sans-serif;margin:10px 0}
    .empty-message{text-align:center;padding:18px;color:#666}

    /* ==== LOADING SPINNER ==== */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 99, 65, 0.3);
      border-radius: 50%;
      border-top-color: #006341;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ==== TOAST NOTIFICATIONS ==== */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 1000;
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    .toast.success {
      background: #006341;
    }
    .toast.error {
      background: #d9534f;
    }
 {
  overflow-x: hidden;
}
@media (max-width: 700px) {
  .topbar {
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
  }

  .tabs {
    flex-wrap: wrap;
    justify-content: center;
  }

  .brand img {
    height: 40px;
  }

  .brand div div:first-child {
    font-size: 14px;
  }

  .brand div div:last-child {
    font-size: 11px;
  }
}
@media (max-width: 900px) {
  .container {
    display: flex;
    flex-direction: column;
    padding: 0 10px;
  }

  .left-column,
  .right-column,
  .center-column {
    width: 100%;
  }

  .card img {
    width: 100%;
    height: auto;
  }
}
@media (max-width: 600px) {
  .composer-top {
    flex-direction: column;
    align-items: stretch;
  }

  .avatar {
    align-self: center;
    margin-bottom: 10px;
  }

  .composer-actions {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }

  .attach-btn {
    justify-content: center;
  }

  .btn {
    width: 100%;
  }
}
@media (max-width: 480px) {
  h1.page-title {
    font-size: 20px;
  }

  .post .body {
    font-size: 14px;
  }

  .tab {
    padding: 8px 10px;
    font-size: 14px;
  }
}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <img src="logoq.jpeg" alt="logo">
      <div>
        <div style="font-weight:700">CONALEP 165 Tuxpan</div>
        <div style="font-size:12px;color:#666">Red interna de la comunidad</div>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="Navegaci√≥n">
      <button class="tab active" data-tab="inicio" onclick="switchTab('inicio')">Inicio</button>
      <button class="tab" data-tab="direccion" onclick="switchTab('direccion')">Direcci√≥n</button>
      <button class="tab" onclick="window.location.href='archivos.html'">Archivos</button>
      <button class="tab" data-tab="promocion" onclick="switchTab('promocion')">Promoci√≥n</button>
    </div>
  </div>

  <div class="container">
    <!-- LEFT: informaci√≥n / mapa / quick links -->
    <div class="left-column">
      <div class="card">
        <h3 style="margin-top:0">Ubicaci√≥n</h3>
        <p style="margin:0 0 12px 0">Calle 2da general silva, Tuxpan, Veracruz</p>
        <img src="ubi.png" alt="ubicaci√≥n">
      </div>

      <div class="card" style="margin-top:14px">
        <h3 style="margin-top:0">Galer√≠a r√°pida</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <img src="CAR.jpeg" style="width:92px;height:72px;object-fit:cover;border-radius:6px">
          <img src="F1.png" style="width:92px;height:72px;object-fit:cover;border-radius:6px">
          <img src="m1.jpeg" style="width:92px;height:72px;object-fit:cover;border-radius:6px">
        </div>
      </div>
    </div>

    <!-- CENTER: FEED -->
    <main class="center-column">
      <h1 class="page-title">PRINCIPAL</h1>

      <!-- Composer (publicaci√≥n) -->
      <section class="composer card" id="composer-section">
        <div class="composer-top">
          <div class="avatar" title="Tu avatar"></div>
          <div class="composer-input">
            <textarea id="post-text" placeholder="¬øQu√© quieres compartir hoy?"></textarea>

            <!-- Attach controls -->
            <div class="composer-actions">
              <div class="attach-btn">
                <label class="tab secondary" title="Adjuntar archivo" for="file-input">Adjuntar</label>
                <input id="file-input" type="file" accept="image/*,video/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
                <button class="tab secondary" id="btn-location" onclick="addLocation()">Direcci√≥n</button>
                <button class="tab secondary" id="btn-promo" onclick="markPromotion()">Promoci√≥n</button>
              </div>

              <div>
                <button class="btn" id="publish-btn">Publicar</button>
              </div>
            </div>

            <!-- preview + progress -->
            <div class="preview-area" id="preview-area" aria-live="polite"></div>
            <div class="progress" id="upload-progress" style="display:none"><i></i></div>
            <div id="composer-error" class="empty-message" style="color:#d9534f;display:none"></div>
          </div>
        </div>
      </section>

      <!-- Feed -->
      <section id="feed" class="card" style="padding:12px 16px;">
        <div id="posts-list">
          <div class="empty-message">Cargando publicaciones...</div>
        </div>
      </section>
    </main>

    <!-- RIGHT: extra / contactos -->
    <aside class="right-column">
      <div class="card">
        <h3 style="margin-top:0">Contacto</h3>
        <p style="margin:0">Email: conalep165@conalep.edu.mx</p>
        <p style="margin:0">Tel√©fono: 783 cesar menso xdd</p>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin-top:0">Preguntas frecuentes</h3>
        <ul style="padding-left:18px;margin:6px 0 0 0;color:#555">
          <li>¬øQu√© carreras ofrecen?</li>
          <li>¬øHorario de atenci√≥n?</li>
        </ul>
      </div>
    </aside>
  </div>

  <!-- Toast notifications -->
  <div id="toast-container"></div>

  <!-- SCRIPTS: Firebase + l√≥gica -->
  <script>
    // === Firebase config (usa la tuya, dej√© la que ven√≠a en el archivo original) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCt7bQO-WAKxxtGRMrRRQ-JEgB9XQARTSU",
      authDomain: "undertale-web.firebaseapp.com",
      databaseURL: "https://undertale-web-default-rtdb.firebaseio.com",
      projectId: "undertale-web",
      storageBucket: "undertale-web.firebasestorage.app",
      messagingSenderId: "382838862726",
      appId: "1:382838862726:web:bef77076da1fca2af6f207"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // util: formatea fechas
    function formatearFecha(date){
      const opciones = {year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'};
      return new Date(date).toLocaleString('es-MX', opciones);
    }

    // util: escape HTML para prevenir XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // util: mostrar notificaciones toast
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.getElementById('toast-container').appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }

    // ---------- Estado del composer ----------
    const fileInput = document.getElementById('file-input');
    const previewArea = document.getElementById('preview-area');
    const publishBtn = document.getElementById('publish-btn');
    const uploadProgress = document.getElementById('upload-progress');
    const uploadProgressBar = uploadProgress.querySelector('i');
    const composerError = document.getElementById('composer-error');
    let selectedFile = null;
    let isPromotion = false;
    let addedLocation = null;

    fileInput.addEventListener('change', (e) => {
      selectedFile = e.target.files[0] || null;
      renderPreview();
    });

    function renderPreview(){
      previewArea.innerHTML = '';
      composerError.style.display = 'none';
      if(!selectedFile) return;
      const ext = selectedFile.type;
      const container = document.createElement('div');
      container.className = 'file-preview';

      if(ext.startsWith('image/')){
        const img = document.createElement('img');
        img.src = URL.createObjectURL(selectedFile);
        img.onload = ()=> URL.revokeObjectURL(img.src);
        container.appendChild(img);
      } else if(ext.startsWith('video/')){
        const vid = document.createElement('video');
        vid.controls = true;
        vid.src = URL.createObjectURL(selectedFile);
        vid.onloadeddata = ()=> URL.revokeObjectURL(vid.src);
        container.appendChild(vid);
      } else {
        // documento / pdf
        const ico = document.createElement('div');
        ico.innerHTML = `<strong>${selectedFile.name}</strong>`;
        container.appendChild(ico);
      }

      const rm = document.createElement('button');
      rm.textContent = 'Eliminar';
      rm.className = 'tab secondary';
      rm.style.marginLeft = '8px';
      rm.addEventListener('click', ()=> {
        selectedFile = null;
        fileInput.value = '';
        renderPreview();
      });
      container.appendChild(rm);
      previewArea.appendChild(container);
    }

    // marcar como promoci√≥n
    function markPromotion(){
      isPromotion = !isPromotion;
      const btn = document.getElementById('btn-promo');
      btn.style.backgroundColor = isPromotion ? '#006341' : 'transparent';
      btn.style.color = isPromotion ? 'white' : 'inherit';
    }

    // agregar direcci√≥n (ejemplo)
    function addLocation(){
      if(!addedLocation){
        addedLocation = "Calle 2da general silva, Tuxpan";
        document.getElementById('btn-location').textContent = 'Direcci√≥n ‚úî';
      } else {
        addedLocation = null;
        document.getElementById('btn-location').textContent = 'Direcci√≥n';
      }
    }

    // publicar post (sube archivo si existe)
    publishBtn.addEventListener('click', publicarPost);
    async function publicarPost(){
      const text = document.getElementById('post-text').value.trim();
      composerError.style.display = 'none';

      if(!text && !selectedFile){
        composerError.textContent = 'Escribe algo o adjunta un archivo antes de publicar.';
        composerError.style.display = 'block';
        return;
      }

      publishBtn.disabled = true;
      publishBtn.innerHTML = '<span class="spinner"></span> Publicando...';
      uploadProgress.style.display = 'none';
      uploadProgressBar.style.width = '0%';

      try {
        let fileUrl = null;
        let fileMeta = null;

        if(selectedFile){
          // limit size (ejemplo 20MB)
          const maxSize = 20 * 1024 * 1024;
          if(selectedFile.size > maxSize){
            throw new Error('Archivo demasiado grande. L√≠mite 20MB.');
          }

          const storageRef = storage.ref().child('posts/' + Date.now() + '_' + selectedFile.name);
          const uploadTask = storageRef.put(selectedFile);

          uploadProgress.style.display = 'block';
          uploadProgressBar.style.width = '0%';

          await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
              (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                uploadProgressBar.style.width = progress + '%';
              },
              (err) => reject(err),
              async () => {
                fileUrl = await storageRef.getDownloadURL();
                fileMeta = {name:selectedFile.name,type:selectedFile.type,size:selectedFile.size};
                resolve();
              }
            );
          });
        }

        // guardar documento en Firestore
        await db.collection('posts').add({
          texto: text || '',
          fileUrl: fileUrl || null,
          fileMeta: fileMeta || null,
          isPromotion: !!isPromotion,
          location: addedLocation || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // limpiar UI
        document.getElementById('post-text').value = '';
        selectedFile = null;
        fileInput.value = '';
        renderPreview();
        isPromotion = false;
        addedLocation = null;
        document.getElementById('btn-promo').style.backgroundColor = 'transparent';
        document.getElementById('btn-promo').style.color = 'inherit';
        document.getElementById('btn-location').textContent = 'Direcci√≥n';

        composerError.style.display = 'none';
        showToast('Publicaci√≥n creada exitosamente', 'success');
      } catch(err){
        console.error(err);
        composerError.textContent = 'Error al publicar: ' + (err.message || err);
        composerError.style.display = 'block';
        showToast('Error al publicar: ' + (err.message || err), 'error');
      } finally {
        publishBtn.disabled = false;
        publishBtn.innerHTML = 'Publicar';
        uploadProgress.style.display = 'none';
        uploadProgressBar.style.width = '0%';
      }
    }

    // ===== mostrar posts en tiempo real =====
    const postsList = document.getElementById('posts-list');

    function showPlaceholder(){
      postsList.innerHTML = '<div class="empty-message">Cargando publicaciones...</div>';
    }
    showPlaceholder();

    // tab filter state
    let currentTab = 'inicio'; // inicio,direccion,archivos,promocion
    function switchTab(tab){
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
      });
      
      // Actualizar t√≠tulo seg√∫n la pesta√±a seleccionada
      const titleElement = document.querySelector('.page-title');
      switch(tab) {
        case 'direccion':
          titleElement.textContent = 'DIRECCI√ìN';
          break;
        case 'archivos':
          titleElement.textContent = 'ARCHIVOS';
          break;
        case 'promocion':
          titleElement.textContent = 'PROMOCI√ìN';
          break;
        default:
          titleElement.textContent = 'PRINCIPAL';
      }
      
      renderPostsCache(); // refresca vista
    }

    // cache posts in memory to apply client filters
    let postsCache = [];

    db.collection('posts').orderBy('createdAt','desc').onSnapshot(snapshot => {
      postsCache = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        postsCache.push({...data, id:doc.id});
      });
      renderPostsCache();
    }, err => {
      postsList.innerHTML = '<div class="empty-message">Error al cargar publicaciones.</div>';
      console.error(err);
      showToast('Error al cargar publicaciones', 'error');
    });

    function renderPostsCache(){
      if(!postsCache.length){
        postsList.innerHTML = '<div class="empty-message">A√∫n no hay publicaciones. S√© el primero en compartir.</div>';
        return;
      }

      // apply filter by tab
      let filtered = postsCache.slice();
      
      if(currentTab === 'archivos'){
        filtered = filtered.filter(p => p.fileUrl);
      } else if(currentTab === 'promocion'){
        filtered = filtered.filter(p => p.isPromotion);
      } else if(currentTab === 'direccion'){
        filtered = filtered.filter(p => p.location);
      }

      if(!filtered.length){
        postsList.innerHTML = '<div class="empty-message">No hay publicaciones para esta secci√≥n.</div>';
        return;
      }

      postsList.innerHTML = '';
      filtered.forEach(p => {
        const postEl = document.createElement('article');
        postEl.className = 'post';

        const createdAt = p.createdAt && p.createdAt.seconds ? p.createdAt.toDate() : (p.createdAt ? new Date(p.createdAt) : new Date());

        postEl.innerHTML = `
          <div class="meta">
            <div class="left">
              <div class="avatar" style="width:40px;height:40px"></div>
              <div>
                <div class="name">Usuario CONALEP</div>
                <div style="font-size:12px;color:#777">${formatearFecha(createdAt)}</div>
              </div>
            </div>
            <div style="font-size:13px;color:${p.isPromotion ? '#d9534f' : '#666'};font-weight:700">
              ${p.isPromotion ? 'PROMOCI√ìN' : ''}
            </div>
          </div>
          <div class="body">${escapeHtml(p.texto || '')}</div>
        `;

        // location
        if(p.location){
          const loc = document.createElement('div');
          loc.style.fontSize = '13px';
          loc.style.color = '#006341';
          loc.style.marginTop = '8px';
          loc.textContent = 'üìç ' + p.location;
          postEl.querySelector('.body').appendChild(loc);
        }

        // media
        if(p.fileUrl){
          const media = document.createElement('div');
          media.className = 'media';
          const type = p.fileMeta && p.fileMeta.type ? p.fileMeta.type : '';

          if(type.startsWith('image/')){
            const img = document.createElement('img');
            img.src = p.fileUrl;
            img.style.maxWidth = '100%';
            img.style.borderRadius = '8px';
            media.appendChild(img);
          } else if(type.startsWith('video/')){
            const v = document.createElement('video');
            v.controls = true;
            v.src = p.fileUrl;
            v.style.width = '100%';
            v.style.borderRadius = '8px';
            media.appendChild(v);
          } else {
            const link = document.createElement('a');
            link.href = p.fileUrl;
            link.target = '_blank';
            link.rel = 'noopener';
            link.textContent = (p.fileMeta && p.fileMeta.name) ? 'Abrir archivo: ' + p.fileMeta.name : 'Abrir archivo';
            link.style.display = 'inline-block';
            link.style.marginTop = '8px';
            media.appendChild(link);
          }
          postEl.appendChild(media);
        }

        // actions (like / comment placeholders)
        const actions = document.createElement('div');
        actions.className = 'actions';
        actions.innerHTML = `
          <div class="post-action" onclick="likePost('${p.id}')">
            <span>üëç</span> Me gusta
          </div>
          <div class="post-action" onclick="commentPost('${p.id}')">
            <span>üí¨</span> Comentar
          </div>
          <div class="post-action" onclick="sharePost('${p.id}')">
            <span>‚ÜóÔ∏è</span> Compartir
          </div>
        `;
        postEl.appendChild(actions);

        postsList.appendChild(postEl);
      });
    }

    // Funciones de interacci√≥n con posts (placeholders)
    function likePost(postId) {
      showToast('Funci√≥n "Me gusta" en desarrollo', 'success');
    }

    function commentPost(postId) {
      showToast('Funci√≥n "Comentar" en desarrollo', 'success');
    }

    function sharePost(postId) {
      showToast('Funci√≥n "Compartir" en desarrollo', 'success');
    }
  </script>

  <!-- SendPulse Live Chat -->
  <script src="https://cdn.pulse.is/livechat/loader.js" data-live-chat-id="68eb30ba026f22b91a0141a8" async></script>
</body>
</html>

